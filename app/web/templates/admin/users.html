{% extends 'common/admin_base.html' %}

{% block title %}Admin Users - {{ title }}{% endblock %}

{% block header %}
    <div class="header-content">
        <h1><i class="fas fa-users"></i> User Management</h1>
        <p>Version 2.0 - Enhanced Admin Interface</p>
    </div>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Modern Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-main">
            <h1 class="page-title-modern">
                <i class="fas fa-users-gear"></i>
                User Management
            </h1>
            <p class="page-subtitle">Manage user accounts, permissions, and access control</p>
        </div>
        <div class="header-actions">
            <div class="search-wrapper">
                <input type="text" id="userSearch" class="search-input" placeholder="Search users by name, email, or phone..." autocomplete="off">
                <i class="fas fa-search search-icon"></i>
                <button class="btn btn-outline-secondary" data-action="clearSearch">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <a href="{{ url_for('admin.create_user_route') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus-circle"></i>
                Add New User
            </a>
            <button class="btn btn-secondary btn-lg" data-action="refreshUsers" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Enhanced Statistics Cards -->
    <div class="stats-grid-modern">
        <div class="stat-card-modern primary-gradient">
            <div class="stat-content">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ user_stats.total_users }}</h3>
                    <p>Total Users</p>
                    <span class="growth-indicator positive">+{{ user_stats.total_users*0.05|round(1) }}%</span>
                </div>
            </div>
            <div class="stat-progress">
                <div class="progress-bar" style="width: 75%"></div>
            </div>
        </div>

        <div class="stat-card-modern success-gradient">
            <div class="stat-content">
                <div class="stat-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ user_stats.admin_users }}</h3>
                    <p>Admin Users</p>
                    <span class="growth-indicator neutral">+{{ user_stats.admin_users*0.02|round(1) }}%</span>
                </div>
            </div>
                <div class="stat-progress">
                <div class="progress-bar" style="width:0%" data-progress="{{ (user_stats.admin_users / user_stats.total_users * 100)|round if user_stats.total_users > 0 else 0 }}"></div>
            </div>
        </div>

        <div class="stat-card-modern info-gradient">
            <div class="stat-content">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ user_stats.regular_users }}</h3>
                    <p>Active Users</p>
                    <span class="growth-indicator positive">+{{ user_stats.regular_users*0.08|round(1) }}%</span>
                </div>
            </div>
            <div class="stat-progress">
                <div class="progress-bar" style="width:0%" data-progress="{{ (user_stats.regular_users / user_stats.total_users * 100)|round if user_stats.total_users > 0 else 0 }}"></div>
            </div>
        </div>

        <div class="stat-card-modern warning-gradient">
            <div class="stat-content">
                <div class="stat-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ user_stats.users_needing_password_reset }}</h3>
                    <p>Pending Resets</p>
                    <span class="growth-indicator negative">{{ user_stats.users_needing_password_reset*0.01|round(1) }}%</span>
                </div>
            </div>
            <div class="stat-progress">
                <div class="progress-bar" style="width:0%" data-progress="{{ (user_stats.users_needing_password_reset / user_stats.total_users * 100)|round if user_stats.total_users > 0 else 0 }}"></div>

    <script nonce="{{ csp_nonce() }}">
    // Set progress-bar widths from data-progress attributes to avoid template syntax inside CSS
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.progress-bar[data-progress]').forEach(function (el) {
            var v = el.getAttribute('data-progress') || '0';
            // ensure numeric-ish value
            if (!isNaN(Number(v))) {
                el.style.width = v + '%';
            }
        });
    });
    // Delegated action handler for buttons using data-action to avoid inline JS attributes
    document.addEventListener('click', function (e) {
        var btn = e.target.closest && e.target.closest('.action-btn');
        if (!btn) return;
        var action = btn.getAttribute('data-action');
        var userId = btn.getAttribute('data-user-id');
        var username = btn.getAttribute('data-username');
        if (!action) return;
        // convert id to number when appropriate
        var uid = Number(userId);
        switch (action) {
            case 'toggle-admin':
                if (typeof toggleAdminStatus === 'function') toggleAdminStatus(uid);
                break;
            case 'force-reset':
                if (typeof forcePasswordReset === 'function') forcePasswordReset(uid);
                break;
            case 'delete-user':
                if (typeof deleteUser === 'function') deleteUser(uid, username);
                break;
        }
    });
    </script>
            </div>
        </div>
    </div>

    <!-- Advanced Filters - Better Layout -->
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-group">
                <label for="roleFilter">Filter by Role:</label>
                <select id="roleFilter" class="filter-select">
                    <option value="">All Roles</option>
                    <option value="admin">Admin Users</option>
                    <option value="user">Regular Users</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Filter by Status:</label>
                <select id="statusFilter" class="filter-select">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="reset">Needs Reset</option>
                    <option value="recent">Recent Activity</option>
                </select>
            </div>
        </div>

        <div class="filter-row">
            <div class="filter-group">
                <label for="sortBy">Sort by:</label>
                <select id="sortBy" class="filter-select">
                    <option value="created_at">Date Created</option>
                    <option value="last_activity">Last Activity</option>
                    <option value="username">Username</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortOrder">Order:</label>
                <select id="sortOrder" class="filter-select">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar - Better Layout -->
    <div class="bulk-actions-bar" id="bulkActions" style="display: none;">
        <div class="bulk-info">
            <span id="bulkCount">0</span> users selected
        </div>
        <div class="bulk-buttons">
            <button class="btn btn-outline-secondary" data-action="clearSelection">
                <i class="fas fa-times"></i> Clear Selection
            </button>
            <button class="btn btn-outline-danger" data-action="bulkDelete">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button class="btn btn-outline-warning" data-action="bulkForceReset">
                <i class="fas fa-key"></i> Force Password Reset
            </button>
            <button class="btn btn-outline-info" data-action="bulkExport">
                <i class="fas fa-download"></i> Export Selected
            </button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th style="width:40px; text-align: center;"> <input type="checkbox" id="selectAllCheckbox" aria-label="Select all visible users"> </th>
                    <th>Username</th>
                    <th>Contact</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Last Activity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-user-id="{{ user.id }}">
                    <td style="width: 40px;">
                        <input type="checkbox" class="row-select" data-user-id="{{ user.id }}" aria-label="Select user {{ user.username|e }}">
                    </td>
                    {# username cell moves right one column - adjust indexes in JS accordingly #}
                    <td>
                        <div class="user-info">
                            <strong>{{ user.username|e }}</strong>
                            {% if user.id == current_user.id %}
                                <span class="badge badge-info">You</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if user.phone %}
                            <i class="fas fa-phone"></i> {{ user.phone|e }}
                        {% elif user.email %}
                            <i class="fas fa-envelope"></i> {{ user.email|e }}
                        {% else %}
                            <span class="text-muted">No contact info</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_admin %}
                            <span class="badge badge-admin">
                                <i class="fas fa-shield-alt"></i> Admin
                            </span>
                        {% else %}
                            <span class="badge badge-user">
                                <i class="fas fa-user"></i> User
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.force_password_change %}
                            <span class="badge badge-warning">
                                <i class="fas fa-exclamation-triangle"></i> Password Reset Required
                            </span>
                        {% else %}
                            <span class="badge badge-success">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <small>{{ user.created_at }}</small>
                    </td>
                    <td>
                        {% if user.last_activity %}
                            <small>{{ user.last_activity }}</small>
                        {% else %}
                            <small class="text-muted">Never</small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}"
                               class="btn btn-sm btn-primary" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            {% if not user.is_admin or user_stats.admin_users > 1 %}
                                <button class="btn btn-sm btn-secondary action-btn" 
                                        data-action="toggle-admin" data-user-id="{{ user.id }}" 
                                        title="Toggle Admin Status">
                                    {% if user.is_admin %}
                                        <i class="fas fa-user-minus"></i>
                                    {% else %}
                                        <i class="fas fa-user-plus"></i>
                                    {% endif %}
                                </button>
                            {% endif %}
                            
                            <button class="btn btn-sm btn-warning action-btn" 
                                    data-action="force-reset" data-user-id="{{ user.id }}" 
                                    title="Force Password Reset">
                                <i class="fas fa-key"></i>
                            </button>
                            
                            {% if user.id != current_user.id and (not user.is_admin or user_stats.admin_users > 1) %}
                                <button class="btn btn-sm btn-danger action-btn" 
                                        data-action="delete-user" data-user-id="{{ user.id }}" data-username="{{ user.username|e }}"
                                        title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="message-container"></div>

<style>
/* ============ IMPROVED STYLES ============ */

/* Modern Dashboard Header */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(33, 150, 243, 0.1));
    border-radius: 15px;
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.header-main h1 {
    margin: 0 0 8px 0;
    color: #fff;
    font-size: 2.2rem;
    font-weight: 700;
}

.page-subtitle {
    color: var(--color-text-secondary);
    margin: 0;
    font-size: 1rem;
}

.header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

.search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    padding: 0 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    transition: all 0.3s ease;
}

.search-wrapper:focus-within {
    background: rgba(255, 255, 255, 0.2);
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
}

.search-input {
    background: transparent;
    border: none;
    padding: 10px 0;
    color: #fff;
    font-size: 0.9rem;
    width: 250px;
    outline: none;
}

.search-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.search-icon {
    margin-right: 10px;
    color: #4CAF50;
    font-size: 0.9rem;
}

.search-wrapper button {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: 5px;
    margin-left: 5px;
}

.btn-lg {
    padding: 12px 20px;
    font-size: 0.95rem;
    font-weight: 600;
}

/* Enhanced Statistics Grid */
.stats-grid-modern {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card-modern {
    background: linear-gradient(145deg, #2a2a2a, #333333);
    border-radius: 15px;
    padding: 25px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.stat-card-modern:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
}

.primary-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #4CAF50, #66BB6A);
}

.success-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #4CAF50, #81C784);
}

.info-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #00BCD4, #4DD0E1);
}

.warning-gradient::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #FF9800, #FFB74D);
}

.stat-content {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.stat-icon {
    font-size: 2.5rem;
    color: #4CAF50;
    margin-right: 20px;
    opacity: 0.9;
}

.stat-info h3 {
    font-size: 2.2rem;
    font-weight: bold;
    color: #fff;
    margin: 0 0 5px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.stat-info p {
    color: var(--color-text-secondary);
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
}

.growth-indicator {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 8px;
    text-align: center;
}

.growth-indicator.positive {
    background: linear-gradient(145deg, #4CAF50, #388E3C);
    color: white;
}

.growth-indicator.negative {
    background: linear-gradient(145deg, #f44336, #d32f2f);
    color: white;
}

.growth-indicator.neutral {
    background: linear-gradient(145deg, #9E9E9E, #757575);
    color: white;
}

.stat-progress {
    margin-top: 15px;
}

.progress-bar {
    height: 4px;
    background: #4CAF50;
    border-radius: 2px;
    transition: width 0.5s ease;
}

/* Filters Section - Better Layout */
.filters-section {
    margin-bottom: 25px;
}

.filter-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    align-items: end;
}

.filter-row:last-child {
    margin-bottom: 0;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
}

.filter-group label {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    font-weight: 600;
    margin-bottom: 5px;
}

.filter-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    min-width: 150px;
    transition: all 0.2s ease;
}

.filter-select:focus {
    outline: none;
    border-color: #4CAF50;
    background: rgba(255, 255, 255, 0.2);
}

/* Bulk Actions */
.bulk-actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(255, 152, 0, 0.1));
    border-radius: 12px;
    border: 1px solid rgba(244, 67, 54, 0.3);
    margin-bottom: 20px;
    animation: slideIn 0.3s ease-out;
}

.bulk-info {
    color: #fff;
    font-weight: 600;
}

.bulk-buttons {
    display: flex;
    gap: 10px;
}

/* Original Styles */
.admin-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.users-table-container {
    background: #2a2a2a;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.2);
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th {
    background: linear-gradient(145deg, #333, #444);
    color: #4CAF50;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #4CAF50;
}

.users-table td {
    padding: 12px;
    border-bottom: 1px solid #444;
    color: #ddd;
}

.users-table tbody tr:hover {
    background: rgba(76, 175, 80, 0.1);
}

.user-info strong {
    color: #fff;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-admin {
    background: linear-gradient(145deg, #f44336, #d32f2f);
    color: white;
}

.badge-user {
    background: linear-gradient(145deg, #2196F3, #1976D2);
    color: white;
}

.badge-success {
    background: linear-gradient(145deg, #4CAF50, #388E3C);
    color: white;
}

.badge-warning {
    background: linear-gradient(145deg, #FF9800, #F57C00);
    color: white;
}

.badge-info {
    background: linear-gradient(145deg, #00BCD4, #0097A7);
    color: white;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 6px 10px;
    font-size: 0.8rem;
}

.text-muted {
    color: #888 !important;
}

.message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    max-width: 400px;
}

.alert {
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 10px;
    border: none;
    font-weight: 500;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.alert-success {
    background: linear-gradient(145deg, #4CAF50, #388E3C);
    color: white;
}

.alert-danger {
    background: linear-gradient(145deg, #f44336, #d32f2f);
    color: white;
}

.alert-warning {
    background: linear-gradient(145deg, #FF9800, #F57C00);
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 20px;
    }

    .header-actions {
        flex-direction: column;
        width: 100%;
    }

    .search-input {
        width: 100%;
    }

    .filters-bar {
        flex-direction: column;
        gap: 12px;
    }

    .stats-grid-modern {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .filter-select {
        width: 100%;
        min-width: auto;
    }

    .bulk-actions-bar {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
}

@media (max-width: 576px) {
    .stats-grid-modern {
        grid-template-columns: 1fr;
    }

    .dashboard-header {
        padding: 15px;
    }

    .header-main h1 {
        font-size: 1.8rem;
    }
}

/* Animations */
@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

    <script>
// Helper: read CSRF token from meta
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : null;
}


function toggleAdminStatus(userId) {
    if (!confirm('Are you sure you want to toggle admin status for this user?')) return;
    const csrf = getCsrfToken();
    fetch(`/admin/users/${userId}/toggle-admin`, {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, csrf ? { 'X-CSRFToken': csrf } : {}),
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMessage(data.error || 'Failed to toggle admin status', 'danger');
        }
    })
    .catch(err => {
        console.error('toggleAdminStatus error', err);
        showMessage('Network error while toggling admin status', 'danger');
    });
}

function forcePasswordReset(userId) {
    if (!confirm('Force password reset for this user? They will need to change their password on next login.')) return;
    const csrf = getCsrfToken();
    fetch(`/admin/users/${userId}/force-password-reset`, {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, csrf ? { 'X-CSRFToken': csrf } : {}),
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMessage(data.error || 'Failed to force password reset', 'danger');
        }
    })
    .catch(err => {
        console.error('forcePasswordReset error', err);
        showMessage('Network error while forcing password reset', 'danger');
    });
}

function deleteUser(userId, username) {
    // username should already be escaped when rendered into data attributes
    if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) return;
    const csrf = getCsrfToken();
    fetch(`/admin/users/${userId}/delete`, {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, csrf ? { 'X-CSRFToken': csrf } : {}),
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMessage(data.error || 'Failed to delete user', 'danger');
        }
    })
    .catch(err => {
        console.error('deleteUser error', err);
        showMessage('Network error while deleting user', 'danger');
    });
}

// Enhanced JavaScript functionalities

// Global variables for filtering and search
let allUsers = [];
let filteredUsers = [];

// Initialize enhanced features
document.addEventListener('DOMContentLoaded', function() {
    allUsers = document.querySelectorAll('.users-table tbody tr');
    filteredUsers = Array.from(allUsers);
    initializeSearch();
    initializeFilters();
    updateUserCount();
    // Wire up row checkbox listeners
    document.querySelectorAll('.row-select').forEach(cb => {
        cb.addEventListener('change', function () {
            const uid = parseInt(this.getAttribute('data-user-id'), 10);
            toggleUserSelection(uid);
        });
    });
    // Header select-all checkbox
    const selectAll = document.getElementById('selectAllCheckbox');
    if (selectAll) {
        selectAll.addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('.users-table tbody tr:not([style*="display: none"]) .row-select');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                const uid = parseInt(cb.getAttribute('data-user-id'), 10);
                if (selectAll.checked) selectedUsers.add(uid); else selectedUsers.delete(uid);
            });
            updateBulkActions();
        });
    }
});

function initializeSearch() {
    const searchInput = document.getElementById('userSearch');
    const clearButton = document.querySelector('.search-wrapper button');

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        filterUsers();
    });

    clearButton.addEventListener('click', function() {
        searchInput.value = '';
        filterUsers();
    });
}

function initializeFilters() {
    const filters = ['roleFilter', 'statusFilter', 'sortBy', 'sortOrder'];

    filters.forEach(filterId => {
        const filter = document.getElementById(filterId);
        if (filter) {
            filter.addEventListener('change', filterUsers);
        }
    });
}

function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.trim().toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;

    let visibleCount = 0;

    allUsers.forEach(row => {
    // account for the leading checkbox column at index 0
    const username = row.cells[1].textContent.trim().toLowerCase();
    const contact = row.cells[2].textContent.trim().toLowerCase();
    const roleBadge = row.cells[3].textContent.trim().toLowerCase();
    const statusBadge = row.cells[4].textContent.trim().toLowerCase();

        // Search filter
        const matchesSearch = !searchTerm ||
            username.includes(searchTerm) ||
            contact.includes(searchTerm);

        // Role filter
        const matchesRole = !roleFilter ||
            (roleFilter === 'admin' && roleBadge.includes('admin')) ||
            (roleFilter === 'user' && !roleBadge.includes('admin'));

        // Status filter
        const matchesStatus = !statusFilter ||
            (statusFilter === 'active' && statusBadge.includes('active')) ||
            (statusFilter === 'reset' && statusBadge.includes('reset')) ||
            (statusFilter === 'recent' && !statusBadge.includes('never'));

        if (matchesSearch && matchesRole && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    updateUserCount(visibleCount);
    sortUsers(sortBy, sortOrder);
}

function sortUsers(sortBy, sortOrder) {
    const tbody = document.querySelector('.users-table tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
    const visibleRows = rows.filter(row => row.style.display !== 'none');

    visibleRows.sort((a, b) => {
        let aVal = '', bVal = '';

        switch(sortBy) {
            case 'created_at':
                // created_at is now at index 5 considering checkbox column
                aVal = a.cells[5].textContent.trim();
                bVal = b.cells[5].textContent.trim();
                break;
            case 'last_activity':
                // last_activity shifted by one due to checkbox column
                aVal = a.cells[6].textContent.trim() === 'Never' ? '1970-01-01' : a.cells[6].textContent.trim();
                bVal = b.cells[6].textContent.trim() === 'Never' ? '1970-01-01' : b.cells[6].textContent.trim();
                break;
            case 'username':
                aVal = a.cells[1].textContent.trim();
                bVal = b.cells[1].textContent.trim();
                break;
        }

        if (sortBy === 'all') {
            return 0;
        }

        const comparison = sortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        return comparison;
    });

    // Reorder visible rows while keeping invisible ones in place
    let allRows = Array.from(tbody.children);
    let insertIndex = 0;

    visibleRows.forEach(row => {
        let currentIndex = allRows.indexOf(row);
        if (currentIndex >= 0) {
            // Remove from current position
            tbody.removeChild(row);
            // Insert at correct position
            tbody.insertBefore(row, tbody.children[insertIndex] || null);
            insertIndex++;
        }
    });
}

function updateUserCount(visibleCount) {
    const totalRows = allUsers.length;
    if (typeof visibleCount === 'undefined') {
        visibleCount = Array.from(allUsers).filter(row => row.style.display !== 'none').length;
    }

    if (visibleCount !== totalRows) {
        showMessage(`Showing ${visibleCount} of ${totalRows} users`, 'info');
    }
}

function clearSearch() {
    document.getElementById('userSearch').value = '';
    filterUsers();
}

function refreshUsers() {
    const refreshBtn = document.getElementById('refreshBtn');
    const originalHTML = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;

    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Bulk Operations Functions
let selectedUsers = new Set();

function toggleUserSelection(userId) {
    const checkbox = document.querySelector(`input[type="checkbox"][data-user-id="${userId}"]`);
    if (!checkbox) return;

    const uid = parseInt(userId, 10);
    if (checkbox.checked) {
        selectedUsers.add(uid);
    } else {
        selectedUsers.delete(uid);
    }

    updateBulkActions();
}

function toggleAllSelections() {
    const visibleCheckboxes = document.querySelectorAll('.users-table tbody tr:not([style*="display: none"]) input[type="checkbox"]');
    const allChecked = Array.from(visibleCheckboxes).every(cb => cb.checked);

    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
        const userId = parseInt(checkbox.getAttribute('data-user-id'), 10);
        if (!allChecked) {
            selectedUsers.add(userId);
        } else {
            selectedUsers.delete(userId);
        }
    });

    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const bulkCount = document.getElementById('bulkCount');

    if (selectedUsers.size > 0) {
        bulkActions.style.display = 'flex';
        bulkCount.textContent = selectedUsers.size;
    } else {
        bulkActions.style.display = 'none';
    }
}

function clearSelection() {
    selectedUsers.clear();
    document.querySelectorAll('.users-table input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateBulkActions();
}

function bulkDelete() {
    if (selectedUsers.size === 0) return;

    if (!confirm(`Are you sure you want to delete ${selectedUsers.size} users? This action cannot be undone.`)) return;

    const userIds = Array.from(selectedUsers);
    const csrf = getCsrfToken();

    // Send a single bulk POST to the server
    fetch('/admin/users/bulk-delete', {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, csrf ? { 'X-CSRFToken': csrf } : {}),
        body: JSON.stringify({ user_ids: userIds })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || `Deleted ${userIds.length} users`, 'success');
            // reload once
            setTimeout(() => window.location.reload(), 800);
        } else {
            showMessage(data.error || 'Bulk delete failed', 'danger');
        }
    })
    .catch(err => {
        console.error('bulkDelete error', err);
        showMessage('Network error during bulk delete', 'danger');
    });
}

function bulkForceReset() {
    if (selectedUsers.size === 0) return;

    if (confirm(`Force password reset for ${selectedUsers.size} users?`)) {
        selectedUsers.forEach(userId => {
            forcePasswordReset(userId);
        });
    }
}

function bulkExport() {
    if (selectedUsers.size === 0) return;

    const userIds = Array.from(selectedUsers);
    showMessage(`Exporting ${userIds.length} users...`, 'info');

    // Create a temporary form to download
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/export/users/bulk';

    userIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_ids';
        input.value = id;
        form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// Enhanced showMessage with animations
function showMessage(message, type = 'success') {
    const container = document.getElementById('messageContainer');

    // Remove existing messages
    container.innerHTML = '';

    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.style.animation = 'slideIn 0.3s ease-out';
    alert.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>${message}</span>
            <button data-action="remove" style="background: none; border: none; color: inherit; cursor: pointer; opacity: 0.7;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    container.appendChild(alert);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentElement) {
            alert.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => alert.remove(), 300);
        }
    }, 5000);
}

// Key shortcuts for better UX
document.addEventListener('keydown', function(e) {
    // Ctrl+F to focus search
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('userSearch').focus();
    }

    // Escape to clear search
    if (e.key === 'Escape' && document.activeElement === document.getElementById('userSearch')) {
        clearSearch();
    }

    // Ctrl+A to toggle all selections when table is focused
    if (e.ctrlKey && e.key === 'a' && document.activeElement && document.activeElement.closest && document.activeElement.closest('.users-table')) {
        e.preventDefault();
        toggleAllSelections();
    }
});
</script>

{% endblock %}
