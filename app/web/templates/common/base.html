<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block description %}CultivAR - Professional Cannabis Grow Management{% endblock %}">
    <meta name="theme-color" content="#ffffff">
    <title>{% block title %}CultivAR{% endblock %}</title>

    <!-- Modern Font Stack (Apple/Samsung Style) - Using Native System Fonts -->
    <!-- Removed Google Material Icons (no longer used) -->

    <!-- Modern Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">

    <!-- Fallback styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/marketing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    {% block styles %}{% endblock %}

    <!-- Make CSP nonce available to JavaScript early in the head so scripts can use it -->
    {# Expose CSRF token to JavaScript via a meta tag for AJAX requests #}
    {% if csrf_token is defined %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <script nonce="{% if csp_nonce %}{{ csp_nonce }}{% endif %}">
        window.cspNonce = '{% if csp_nonce %}{{ csp_nonce }}{% endif %}';
    </script>
    {# Conditional dev debug overlay loader: only when URL contains ?debug=1; load early to capture logs #}
    {% if request and request.args.get('debug') %}
    <script src="{{ url_for('static', filename='js/dev-debug.js') }}"></script>
    {% endif %}
</head>
<body>
    <!-- Modern Theme Toggle (Glass Morphism Style) -->
    <div class="theme-toggle-fixed">
        <button class="theme-toggle glass-card" aria-label="Toggle theme">
            <!-- Icon will be inserted via CSS -->
        </button>
    </div>

    <div class="app-container">
        {% set user_is_authenticated = current_user.is_authenticated|default(False) %}
        {% if user_is_authenticated %}

        <!-- Glass Morphism Overlay for Mobile -->
        <div class="sidebar-overlay"></div>

        <!-- Modern Glass Sidebar -->
        <aside class="sidebar glass">
            {% include 'common/sidebar.html' %}
        </aside>

        <!-- Modern Hamburger Menu -->
        <button class="btn hamburger-glossy" id="hamburger-menu" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>

        <main class="main-content">
            <!-- Apple-style Header with Glass Morphism -->
            <header class="nav-glass content-header">
                <div class="container d-flex justify-between items-center h-full">
                    <div class="header-left d-flex items-center gap-lg">
                        <button class="btn btn-icon menu-toggle" id="menu-toggle" aria-label="Toggle sidebar">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title">
                            {% block header %}{% endblock %}
                        </h1>
                    </div>

                    <div class="header-right d-flex items-center gap-md">
                        <!-- Modern Cart Button -->
                        <div class="cart-nav" id="cart-nav">
                            <a href="{{ url_for('market.cart') }}" class="btn glass-card position-relative" aria-label="Shopping Cart">
                                <i class="fas fa-shopping-cart"></i>
                                <span id="cart-counter" class="counter badge-danger position-absolute">
                                    0
                                </span>
                            </a>
                        </div>

                        <!-- Modern Settings Button -->
                        <a href="#" class="btn btn-icon glass-card" aria-label="Settings">
                            <i class="fas fa-cog"></i>
                        </a>

                        <!-- Modern User Menu -->
                        <div class="user-menu glass-card">
                            <button class="btn user-menu-trigger d-flex items-center gap-sm" id="userMenuDropdown">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <span class="username">{{ current_user.username }}</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>

                            <!-- Apple-style Dropdown Menu -->
                            <div class="user-dropdown glass-card" aria-labelledby="userMenuDropdown">
                                <a class="dropdown-item" href="{{ url_for('market.cart') }}">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>Shopping Cart</span>
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-cog"></i>
                                    <span>Settings</span>
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Modern Content Area -->
            <div class="content-body">
                <!-- Apple-style Alert Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="alert-container">
                            {% for category, message in messages %}
                                <div class="alert glass-card alert-{{ category }}" role="alert">
                                    <i class="
                                        {% if category == 'success' %}fas fa-check-circle
                                        {% elif category == 'error' %}fas fa-exclamation-circle
                                        {% elif category == 'warning' %}fas fa-exclamation-triangle
                                        {% else %}fas fa-info-circle
                                        {% endif %}
                                    "></i>
                                    <span>{{ message }}</span>
                                    <button class="btn btn-icon alert-close" aria-label="Close alert">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <!-- Main Content with Modern Spacing -->
                <div class="container">
                    {% block content %}{% endblock %}
                </div>
            </div>
        </main>

        {% else %}

        <!-- Modern Authentication Container -->
        <div class="auth-container landing-page">
            {% block auth_content %}{% endblock %}
        </div>

        {% endif %}
    </div>

    <!-- Modern JavaScript Stack -->
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

    <!-- Design System Core (must load after window.cspNonce is set) -->
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/styles.js') }}"></script>

    <!-- Application Scripts -->
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cart-utilities.js') }}"></script>

    <!-- Modern UI Interactive Script moved to external bundle (main.js) to avoid inline script CSP issues -->

    {% block scripts %}{% endblock %}

</body>
</html>
