{% extends 'common/base.html' %}

{% block title %}Dashboard - CultivAR{% endblock %}

{% block header %}Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-widgets.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Welcome back, {{ current_user.username }}!</h1>
        <div class="dashboard-controls">
            <button class="widget-settings-btn" title="Customize Dashboard Layout">
                <i class="fas fa-cog"></i> Customize
            </button>
            <button class="btn btn-sm btn-primary" id="refresh-dashboard">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Dashboard Widgets Container -->
    <div class="dashboard-widgets" id="dashboard-widgets">
        <!-- Widgets will be dynamically loaded here -->
    </div>
</div>

<!-- Widget Settings Panel -->
<div class="widget-settings-panel" id="widget-settings-panel">
    <div class="settings-header">
        <h3>Dashboard Customization</h3>
        <button class="btn btn-sm btn-secondary widget-settings-close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="settings-content">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Drag & Drop Mode:</strong> When enabled, you can drag widgets by their handle to reorder your dashboard.
        </div>

        <div class="mt-3">
            <button class="btn btn-success btn-block" id="enable-drag-drop">
                <i class="fas fa-hand-paper"></i> Enable Drag & Drop
            </button>
            <button class="btn btn-secondary btn-block" id="disable-drag-drop" style="display: none;">
                <i class="fas fa-hand-paper"></i> Disable Drag & Drop
            </button>
        </div>

        <div class="mt-4">
            <h4>Widget Visibility</h4>
            <p class="text-muted small">Show or hide widgets on your dashboard.</p>
            <div class="widget-toggles" id="widget-toggles">
                <!-- Widget toggles will be populated here -->
            </div>
        </div>

        <div class="mt-4">
            <h4>Layout Options</h4>
            <button class="btn btn-sm btn-outline-secondary btn-block" id="reset-layout">
                <i class="fas fa-undo"></i> Reset to Default Layout
            </button>
        </div>
    </div>
</div>

<!-- Settings Panel Overlay (initially hidden) -->
<div class="settings-overlay" id="settings-overlay" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard-widgets.js') }}"></script>
<script>
$(document).ready(function() {
    let dragDropEnabled = false;

    // Initialize dashboard only if widget system is available
    if (window.dashboardWidgets) {
        const dashboard = window.dashboardWidgets;
        // Load initial data
        loadDashboardData();
        // Populate widget toggles
        populateWidgetToggles();
    }

    // Refresh dashboard
    $('#refresh-dashboard').click(function() {
        $(this).find('i').addClass('fa-spin');
        loadDashboardData();
        setTimeout(() => {
            $(this).find('i').removeClass('fa-spin');
        }, 1000);
    });

    // Settings panel toggle
    $('.widget-settings-btn').click(function() {
        $('#widget-settings-panel').addClass('active');
        $('#settings-overlay').show().addClass('active');
    });

    $('.widget-settings-close, #settings-overlay').click(function() {
        $('#widget-settings-panel').removeClass('active');
        $('#settings-overlay').removeClass('active').hide();
    });

    // Enable drag and drop
    $('#enable-drag-drop').click(function() {
        dragDropEnabled = true;
        $(this).hide();
        $('#disable-drag-drop').show();

        // Enable drag handles
        $('.widget-drag-handle').css('opacity', '1').css('cursor', 'grab');

        // Show notification
        showNotification('Drag & Drop enabled! Drag widgets by their handles to reorder.', 'success');
    });

    // Disable drag and drop
    $('#disable-drag-drop').click(function() {
        dragDropEnabled = false;
        $(this).hide();
        $('#enable-drag-drop').show();

        // Hide drag handles
        $('.widget-drag-handle').css('opacity', '0');

        // Show notification
        showNotification('Drag & Drop disabled.', 'info');
    });

    // Reset layout
    $('#reset-layout').click(function() {
        if (confirm('Reset dashboard to default layout? This will undo all your customizations.')) {
            localStorage.removeItem('dashboard-widgets');
            location.reload();
        }
    });

    // Widget toggles
    $(document).on('click', '.widget-toggle', function() {
        $(this).toggleClass('active');
        const widgetId = $(this).data('widget-id');
        if (window.dashboardWidgets) {
            window.dashboardWidgets.toggleWidget(widgetId);
        }
    });

    // Quick action handlers
    $(document).on('click', '.quick-action-btn', function() {
        const action = $(this).data('action');
        handleQuickAction(action);
    });

    // Widget expand handlers
    $(document).on('click', '.widget-expand-btn', function() {
        const widget = $(this).closest('.dashboard-widget');
        widget.toggleClass('expanded');
    });

    // Timeline navigation
    $(document).on('click', '#timeline-prev, #timeline-next', function() {
        const direction = $(this).attr('id').includes('prev') ? 'prev' : 'next';
        if (window.dashboardWidgets) {
            window.dashboardWidgets.navigateTimeline(direction);
        }
    });

    // Auto-refresh environmental data every 30 seconds
    setInterval(loadEnvironmentalData, 30000);

    function populateWidgetToggles() {
        const togglesContainer = $('#widget-toggles');
        if (!window.dashboardWidgets || !window.dashboardWidgets.widgetConfig) return;

        const widgets = window.dashboardWidgets.widgetConfig.widgets || [];
        const togglesHtml = widgets.map(widget => `
            <div class="widget-toggle-item">
                <span class="widget-toggle-label">${widget.id.charAt(0).toUpperCase() + widget.id.slice(1).replace('-', ' ')}</span>
                <div class="widget-toggle ${widget.enabled ? 'active' : ''}" data-widget-id="${widget.id}"></div>
            </div>
        `).join('');

        togglesContainer.html(togglesHtml);
    }
});

function loadDashboardData() {
    loadPlantData();
    loadEnvironmentalData();
    loadSensorData();
    loadStrainData();
    loadHarvestData();
}

function loadPlantData() {
    // Mock plant data - replace with actual API call
    const plantCount = Math.floor(Math.random() * 10) + 1;
    $('#plants-count').text(plantCount);

    // Load recent plants
    const recentPlantsHtml = `
        <div class="plant-item">
            <span class="plant-name">Northern Lights #1</span>
            <span class="plant-status status-flowering">Flowering</span>
        </div>
        <div class="plant-item">
            <span class="plant-name">White Widow #2</span>
            <span class="plant-status status-active">Vegetative</span>
        </div>
        <div class="plant-item">
            <span class="plant-name">OG Kush #3</span>
            <span class="plant-status status-active">Seedling</span>
        </div>
    `;
    $('#recent-plants').html(recentPlantsHtml);
}

function loadEnvironmentalData() {
    // Mock environmental data
    const envData = [
        { icon: 'thermometer-half', label: 'Temperature', value: '24Â°C', status: 'optimal' },
        { icon: 'tint', label: 'Humidity', value: '65%', status: 'optimal' },
        { icon: 'wind', label: 'Air Flow', value: 'Good', status: 'optimal' },
        { icon: 'lightbulb', label: 'Light', value: '600W', status: 'optimal' }
    ];

    const envHtml = envData.map(item => `
        <div class="env-item">
            <div class="env-icon">
                <i class="fas fa-${item.icon}"></i>
            </div>
            <div class="env-value">${item.value}</div>
            <div class="env-label">${item.label}</div>
        </div>
    `).join('');

    $('#environmental-data').html(envHtml);
}

function loadSensorData() {
    $('#sensors-count').text(Math.floor(Math.random() * 5) + 1);
}

function loadCultivarData() {
    $('#cultivars-count').text(Math.floor(Math.random() * 8) + 3);
}

function loadHarvestData() {
    $('#harvests-count').text(Math.floor(Math.random() * 3));
}

function handleQuickAction(action) {
    switch(action) {
        case 'add-plant':
            window.location.href = '{{ url_for("dashboard.plants") }}';
            break;
        case 'water-all':
            if (confirm('Water all active plants?')) {
                showNotification('All plants watered successfully!', 'success');
            }
            break;
        case 'record-activity':
            $('#recordActivityModal').modal('show');
            break;
        case 'check-sensors':
            loadEnvironmentalData();
            showNotification('Sensor data refreshed', 'info');
            break;
    }
}

function showNotification(message, type = 'info') {
    const alert = $(`
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);

    $('.content-body').prepend(alert);

    setTimeout(() => {
        alert.alert('close');
    }, 3000);
}

// Register service worker for PWA, but guard registration in unsupported contexts
(function() {
    function canRegisterServiceWorker() {
        try {
            if (!('serviceWorker' in navigator)) return false;
            // Avoid registering inside iframes or embedded webviews
            if (window.self !== window.top) return false;
            // Service workers require a secure context: https or localhost
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') return false;
            return true;
        } catch (e) {
            return false;
        }
    }

    if (canRegisterServiceWorker()) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/sw.js')
                .then(function(registration) {
                    console.log('Service Worker registered successfully', registration.scope);
                })
                .catch(function(error) {
                    console.warn('Service Worker registration failed', error);
                });
        });
    } else {
        // Helpful debug log for environments where service workers are unsupported (webviews, file://, etc.)
        if (typeof console !== 'undefined' && console.debug) {
            console.debug('Service Worker registration skipped: unsupported context or insecure origin');
        }
    }
})();
</script>

<style>
.settings-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: all 0.3s ease;
    display: none;
}

.settings-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    display: block;
}

.expanded {
    grid-column: 1 / -1 !important;
    min-height: 500px !important;
}

@media (max-width: 768px) {
    .expanded {
        min-height: 400px !important;
    }
}
</style>
{% endblock %}
