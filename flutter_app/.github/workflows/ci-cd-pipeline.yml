name: CultivAREmergant CI/CD Pipeline

on:
  push:
    branches: [ main, develop, release/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily builds to detect breaking changes
    - cron: '0 2 * * *'

env:
  # Android configuration
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'
  
  # Flutter configuration
  FLUTTER_VERSION: '3.16.0'
  
  # Build configurations
  NODE_VERSION: '18'

jobs:
  # Code Quality and Analysis
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install analysis tools
        run: |
          npm install -g eslint@latest
          npm install -g prettier@latest
          npm install -g yaml-lint@latest
          npm install -g markdownlint@latest
      
      - name: Run linting checks
        run: |
          # Check for code style violations
          echo "Running code quality checks..."
          
          # Check markdown files
          find . -name "*.md" -not -path "./node_modules/*" | xargs markdownlint || true
          
          # Check YAML files
          find . -name "*.yml" -o -name "*.yaml" | xargs yaml-lint || true
      
      - name: Security scan
        run: |
          echo "Running security scan..."
          # Add security scanning tools here
      
      - name: Check file sizes
        run: |
          echo "Checking asset file sizes..."
          find ./assets -type f -size +10M -exec ls -lh {} \; || true
      
      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report
          path: |
            quality-reports/

  # Static Analysis and Testing
  static-analysis:
    name: Static Analysis & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Cache Flutter packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ~/.flutter-devtools
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run static analysis
        run: |
          flutter analyze --no-pub
          echo "Static analysis completed"
      
      - name: Run unit tests
        run: |
          flutter test --no-pub --coverage --reporter json > test-report.json || true
          # Generate coverage report
          if [ -f coverage/lcov.info ]; then
            echo "Coverage report generated"
          fi
      
      - name: Generate test coverage report
        run: |
          if [ -f test-report.json ]; then
            echo "Test report available"
          fi
      
      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: |
            analysis-results/
            coverage/
            test-report.json

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run integration tests
        run: |
          flutter test integration_test/ --no-pub || true
      
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: integration_test/

  # Build Android App Bundle (AAB)
  build-android-aab:
    name: Build Android App Bundle
    runs-on: ubuntu-latest
    needs: [code-quality, static-analysis, integration-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Cache Flutter packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ~/.flutter-devtools
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run static analysis
        run: flutter analyze --no-pub
      
      - name: Run unit tests
        run: flutter test --no-pub
      
      - name: Build Android App Bundle
        run: |
          flutter build appbundle \
            --release \
            --target-platform android-arm64,android-arm \
            --obfuscate \
            --split-debug-info=build/debug-info/ \
            --tree-shake-icons \
            --source-maps
      
      - name: Generate release notes
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "# CultivAREmergant Release $(git rev-parse --short HEAD)" > release-notes.md
            echo "" >> release-notes.md
            echo "**Version:** $(cat pubspec.yaml | grep version | cut -d' ' -f2)" >> release-notes.md
            echo "**Build:** $(date +%Y%m%d-%H%M%S)" >> release-notes.md
            echo "" >> release-notes.md
            echo "## Changes" >> release-notes.md
            git log --pretty=format:"- %s" HEAD~1..HEAD >> release-notes.md || echo "- Initial release" >> release-notes.md
          fi
      
      - name: Upload Android App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-app-bundle
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
      
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            build/app/outputs/bundle/release/
            release-notes.md

  # Build Android APK
  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [code-quality, static-analysis, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Cache Flutter packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ~/.flutter-devtools
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Android APK
        run: |
          flutter build apk \
            --release \
            --split-per-abi \
            --obfuscate \
            --split-debug-info=build/debug-info/
      
      - name: Upload Android APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/
          retention-days: 7

  # Build iOS App (macOS only)
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    needs: [code-quality, static-analysis, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Cache Flutter packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ~/.flutter-devtools
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build iOS App
        run: |
          flutter build ios \
            --release \
            --obfuscate \
            --split-debug-info=build/debug-info/ \
            --no-codesign
      
      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/
          retention-days: 7

  # Performance Testing
  performance-tests:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: [static-analysis]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run performance tests
        run: |
          flutter test test/performance/ || echo "No performance tests found"
      
      - name: Build and test performance
        run: |
          flutter build apk --release --analyze-size || true
      
      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            test/performance/
            build/output-*.txt

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: [build-android-aab]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle
          path: app-bundle/
      
      - name: Run security analysis
        run: |
          echo "Running security analysis on built artifacts..."
          # Add security scanning tools here
          # - Mobile security frameworks
          # - Dependency vulnerability scanning
          # - Code obfuscation verification
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-report
          path: security-reports/

  # Deploy to Testing (Firebase App Distribution)
  deploy-testing:
    name: Deploy to Testing
    runs-on: ubuntu-latest
    needs: [build-android-aab, build-android-apk, security-scan]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle
          path: app-bundle/
      
      - name: Setup Node.js for Firebase CLI
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Deploy to Firebase App Distribution
        run: |
          echo "Deploying to Firebase App Distribution..."
          # firebase appdistribution:distribute app-bundle/app-release.aab \
          #   --app ${{ secrets.FIREBASE_APP_ID_TESTING }} \
          #   --groups "testing,internal" \
          #   --release-notes-file release-notes.md \
          #   --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  # Deploy to Play Store (Production)
  deploy-play-store:
    name: Deploy to Google Play Store
    runs-on: ubuntu-latest
    needs: [build-android-aab, security-scan]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle
          path: app-bundle/
      
      - name: Setup Ruby for Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: './fastlane'
      
      - name: Install Fastlane
        run: |
          cd fastlane
          bundle install
      
      - name: Deploy to Play Store
        run: |
          echo "Deploying to Google Play Store..."
          # cd fastlane
          # bundle exec fastlane supply --track production --json_key_data ${{ secrets.GOOGLE_PLAY_JSON_KEY }} --package_name com.cultivaremergant.app app-bundle/app-release.aab
        env:
          GOOGLE_PLAY_JSON_KEY: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}

  # Deploy to App Store (iOS)
  deploy-app-store:
    name: Deploy to App Store
    runs-on: macos-latest
    needs: [build-ios, security-scan]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download iOS build
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: ios-build/
      
      - name: Setup Ruby for Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: './fastlane'
      
      - name: Install Fastlane
        run: |
          cd fastlane
          bundle install
      
      - name: Deploy to App Store
        run: |
          echo "Deploying to Apple App Store..."
          # cd fastlane
          # bundle exec fastlane release
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}

  # Notify deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-testing, deploy-play-store, deploy-app-store]
    if: always()
    steps:
      - name: Notify success
        if: needs.deploy-testing.result == 'success' || needs.deploy-play-store.result == 'success' || needs.deploy-app-store.result == 'success'
        run: |
          echo "Deployment successful!"
          # Add notification logic here (Slack, Discord, email, etc.)
      
      - name: Notify failure
        if: needs.deploy-testing.result == 'failure' || needs.deploy-play-store.result == 'failure' || needs.deploy-app-store.result == 'failure'
        run: |
          echo "Deployment failed!"
          # Add notification logic here (Slack, Discord, email, etc.)